<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asistente Vinted con Imagen</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ml5/0.12.2/ml5.min.js"></script>
<style>
body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; background: #f5f5f5; }
h1 { text-align: center; }
label { font-weight: bold; margin-top: 15px; display: block; }
input, select, button, textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; }
textarea { height: 200px; font-family: monospace; }
.card { background: #fff; padding: 20px; margin: 20px 0; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
button { background: #007bff; color: #fff; border: none; cursor: pointer; font-weight: bold; }
button:hover { background: #0056b3; }
.copy-btn { background: #28a745; margin-top: 10px; }
.copy-btn:hover { background: #1e7e34; }
img { max-width: 100%; margin-top: 10px; border-radius: 5px; }
</style>
</head>
<body>
<h1>Asistente Vinted con Imagen</h1>

<label>Sube una imagen de la prenda:</label>
<input type="file" id="imagen" accept="image/*">

<label>Sexo:</label>
<select id="sexo">
  <option value="">Selecciona</option>
  <option value="Mujer">Mujer</option>
  <option value="Hombre">Hombre</option>
</select>

<label>Talla:</label>
<input type="text" id="talla" placeholder="Ej: L">

<label>Estilo:</label>
<input type="text" id="estilo" placeholder="Ej: Skate, Chic, Streetwear">

<button id="generarBtn">Generar descripción</button>

<h2>Prenda Detectada</h2>
<div id="resultado" class="card"></div>

<script>
let classifier = null;

ml5.imageClassifier('MobileNet').then(model => {
  classifier = model;
  console.log('Modelo cargado');
});

const vocabSEO = ["Streetwear","Oversize","Casual","Chic","Sporty","Urban","Skate","Comfy","Luxury","Retro"];

function obtenerColorDominante(img){
    const canvas = document.createElement("canvas");
    canvas.width = img.width; canvas.height = img.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img,0,0,img.width,img.height);
    const data = ctx.getImageData(0,0,img.width,img.height).data;
    let r=0,g=0,b=0,count=0;
    for(let i=0;i<data.length;i+=4){
        r+=data[i]; g+=data[i+1]; b+=data[i+2]; count++;
    }
    r=Math.round(r/count); g=Math.round(g/count); b=Math.round(b/count);
    return `rgb(${r},${g},${b})`;
}

function generarTitulo(tipo, talla, sexo, estilo){
    let extra = [];
    while(extra.join(' ').length < 40){
        let w = vocabSEO[Math.floor(Math.random()*vocabSEO.length)];
        if(!extra.includes(w)) extra.push(w);
    }
    let t = `${tipo} ${sexo || ""} Talla ${talla || ""} ${estilo || ""} ${extra.join(' ')}`;
    return t.trim();
}

function generarSubtitulo(tipo, sexo, estilo){
    return `${tipo} para ${sexo || "adulto"}, estilo ${estilo || "moderno y cómodo"}, ideal para looks urbanos y fashion.`;
}

function generarHashtags(tipo, sexo, estilo){
    const base = [`#${tipo.replace(/\s+/g,'')}`, `#${sexo?.toLowerCase() || ''}`, `#${estilo.replace(/\s+/g,'') || ''}`, "#mujerchic"];
    let hashtags = [...base];
    for(let i=0;i<vocabSEO.length && hashtags.length<15;i++){
        const tag = "#" + vocabSEO[i].toLowerCase();
        if(!hashtags.includes(tag)) hashtags.push(tag);
    }
    return hashtags.slice(0,15);
}

function analizarImagen() {
    const fileInput = document.getElementById('imagen');
    if(fileInput.files.length === 0){
        alert("Selecciona una imagen primero");
        return;
    }

    if(!classifier){
        alert("El modelo aún no está cargado, espera unos segundos.");
        return;
    }

    const sexo = document.getElementById('sexo').value;
    const talla = document.getElementById('talla').value.trim();
    const estilo = document.getElementById('estilo').value.trim();

    const reader = new FileReader();
    reader.onload = function(event){
        const img = new Image();
        img.src = event.target.result;
        img.width = 224; img.height = 224;
        img.style.display = "block"; // importante que sea visible para MobileNet
        document.body.appendChild(img);

        img.onload = () => {
            // Pequeña espera para asegurar carga completa
            setTimeout(()=>{
                classifier.classify(img).then(results => {
                    console.log(results);
                    const tipo = results[0].label.split(",")[0];
                    const colorDominante = obtenerColorDominante(img);

                    const titulo = generarTitulo(tipo, talla, sexo, estilo);
                    const subtitulo = generarSubtitulo(tipo, sexo, estilo);
                    const hashtags = generarHashtags(tipo, sexo, estilo);

                    document.getElementById('resultado').innerHTML = `
                        <img src="${img.src}" style="max-width:300px;">
                        <p><strong>${titulo}</strong></p>
                        <p>${subtitulo}</p>
                        <p style="color:${colorDominante}">Color aproximado: ${colorDominante}</p>
                        <p>${hashtags.join(" ")}</p>
                        <textarea readonly>${titulo}\n\n${subtitulo}\n\nColor: ${colorDominante}\n\nHashtags: ${hashtags.join(" ")}</textarea>
                        <button class="copy-btn" onclick="copiarTexto(this)">Copiar al portapapeles</button>
                    `;
                    img.remove();
                }).catch(err => console.error(err));
            }, 200);
        };
    };
    reader.readAsDataURL(fileInput.files[0]);
}

function copiarTexto(btn){
    const text = btn.previousElementSibling.value;
    navigator.clipboard.writeText(text).then(()=>{ alert("Descripción copiada al portapapeles"); });
}

document.getElementById('generarBtn').addEventListener('click', analizarImagen);
</script>
</body>
</html>

